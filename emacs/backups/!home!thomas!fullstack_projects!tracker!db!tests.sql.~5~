\echo 'Run tests'

\set VERBOSITY terse
\set ON ERROR STOP true

set search_path = data, public;

\echo 'list exercises'
select * from exercises;

\echo 'list recent workout ids/dates'
select * from workouts
order by workout_id desc
limit 10;

\echo 'show most recent workout'
with most_recent_workout_id as (
     select workout_id from workouts
     order by workout_id desc
     limit 1
), workout_stage_ids as (
     select workout_stage_id from workout_stages
     where workout_id = (select * from most_recent_workout_id)
), workout_exercises as (
     select * from sets
     where workout_stage_id in (select * from workout_stage_ids)
), workout_info as (
     select workout_stage_id, set_number, set_weight, set_reps,
     	    exercises.exercise_name
     from workout_exercises
     left join exercises
     on workout_exercises.set_exercise = exercises.exercise_id
)
select
	workout_stages.workout_stage_number,
	workout_info.exercise_name,
	workout_info.set_number,
	workout_info.set_weight,
	workout_info.set_reps
from workout_info
left join workout_stages
on workout_info.workout_stage_id = workout_stages.workout_stage_id;

\echo 'Develop weekly view on measurements'
select *
from weekly_averages;

\echo 'Develop tonnage per workout'
with workout_stage_ids as (                                                                                  
     select workout_stage_id from workout_stages                                                           
     where workout_id = 1                                            
), workout_exercises as (                                                                                  
     select * from sets                                                                                    
     where workout_stage_id in (select * from workout_stage_ids)                                           
), workout_info as (                                                                                       
     select workout_stage_id, set_number, set_weight, set_reps,                                            
            exercises.exercise_name                                                                        
     from workout_exercises                                                                                
     left join exercises                                                                                   
     on workout_exercises.set_exercise = exercises.exercise_id                                             
)                                                                                                          
select                                                                                                     
        workout_stages.workout_stage_number,                                                               
        workout_info.exercise_name,                                                                        
        workout_info.set_number,                                                                           
        workout_info.set_weight,                                                                           
        workout_info.set_reps                                                                              
from workout_info                                                                                          
left join workout_stages                                                                                   
on workout_info.workout_stage_id = workout_stages.workout_stage_id;                                        

\echo 'dev'
with stages as (
select workout_stage_id
from workout_stages
where workout_id = 1
), sets as (
     select * from sets                                                                                    
     where workout_stage_id in (select * from stages) 
), exercise_tonnage as (
select (set_weight * set_reps) as tonnage
       , exercises.exercise_name
from sets
left join exercises
on sets.set_exercise = exercises.exercise_id 
)
select exercise_name, sum(tonnage) as tonnage
from exercise_tonnage
group by exercise_name
